ENC-001: Core type definitions
- Created src/server/encounters/types.ts
- Exports: Context, Selector, MechanicResult, Script, MechanicParams, ScriptRunner
- MechanicParams = discriminated union for all mechanic types with optional defaults
- Build passes

ENC-002: Basic targeting selectors
- Created src/server/encounters/targeting.ts
- all(): filters hp > 0
- random(n): Fisher-Yates shuffle, handles n > players.length
- closest(point): Euclidean distance, returns single-element array
- furthest(point): Euclidean distance, returns single-element array
- All return Selector functions (not results)
- Build passes

ENC-003: Advanced targeting selectors
- nClosest(n, point): sorts by distance ascending, takes first n
- nFurthest(n, point): sorts by distance descending, takes first n
- withStatus(effect): filters players whose statusEffects includes effect
- withoutStatus(effect): filters players whose statusEffects excludes effect
- All handle edge cases (empty living players, n > players.length)
- Build passes

ENC-004: Selector combinators
- exclude(selector, excluded): filters out players by id from excluded results
- first(n, selector): takes first n results from selector
- union(...selectors): combines all selector results, dedupes by player id
- All combinators compose with existing selectors (e.g., exclude(random(2), closest(point)))
- Build passes

ENC-005: Context factory
- Created src/server/encounters/context.ts
- createContext() returns empty Context object {}
- Simple foundation for future context initialization logic
- Build passes

ENC-006: Basic ScriptRunner implementation
- Created src/server/encounters/script-runner.ts
- ScriptRunnerImpl class takes Game in constructor
- spawn(): routes MechanicParams to correct game.spawn* method, returns mechanic ID
- wait(ms): returns Promise resolving after ms via setTimeout
- getState(): returns GameState from game.getState()
- select(selector): invokes selector with state + context, returns PlayerState[]
- Modified game.ts: all spawn* methods now return string (mechanic ID)
- Added game.getState() method
- waitForResolve/run throw "not implemented" per spec
- Build passes

ENC-007: MechanicResult emission on resolution
- Game extends EventEmitter
- Added onMechanicResult callback to MechanicManager
- MechanicManager calls getResult() on mechanics before resolve(), emits result
- Default result: { mechanicId, type, data: { position } } for positional mechanics
- Added optional getResult(players) method to BaseMechanic interface
- Implemented getResult() on ChariotMechanic: returns position + hitPlayerIds
- Implemented getResult() on SpreadMechanic: returns targetPlayerId, position, hitPlayerIds
- Game.constructor registers callback that emits 'mechanicResolved' event
- Files: game.ts, mechanics/manager.ts, mechanics/types.ts, mechanics/chariot.ts, mechanics/spread.ts
- Build passes

ENC-008: waitForResolve implementation
- Implemented waitForResolve(mechanicId) in ScriptRunnerImpl
- Returns Promise<MechanicResult> that resolves when mechanic resolves
- Subscribes to game 'mechanicResolved' event, filters by mechanicId
- Unsubscribes handler after receiving matching event
- Files: src/server/encounters/script-runner.ts
- Build passes

ENC-009: run(script) for sub-script execution
- Implemented async run(script) in ScriptRunnerImpl
- Creates fresh context via createContext() for each sub-script
- Calls script(this, ctx) and awaits completion
- Errors propagate naturally (not caught/swallowed)
- Files: src/server/encounters/script-runner.ts
- Build passes

ENC-010: execute(script) entry point + runEncounter helper
- Added execute(script) method to ScriptRunnerImpl
- Creates initial context via createContext()
- Wraps script execution in try/catch, logs errors via console.error
- Added runEncounter(game, script) convenience function export
- Creates ScriptRunnerImpl and calls execute()
- Files: src/server/encounters/script-runner.ts
- Build passes

ENC-011: First test script
- Created src/server/encounters/scripts/test-sequence.ts
- testSequenceScript exported as Script type
- Spawns chariot at arena center, waits 3s, spawns spreads on random(2) players, waits 3s, spawns chariot
- Uses runner.select(random(2)) for targeting
- Files: src/server/encounters/scripts/test-sequence.ts
- Build passes

ENC-012: Admin runTestScript handler + button
- Added socket.on('admin:runTestScript') handler in src/server/index.ts
- Handler calls runEncounter(game, testSequenceScript)
- Added emitRunTestScript() to __adminTest in src/client/admin.ts
- Added button #run-test-script-btn to admin panel in public/index.html
- Button click handler emits admin:runTestScript
- Playwright verified: chariot → 3s wait → spreads → 3s wait → chariot
- Files: src/server/index.ts, src/client/admin.ts, public/index.html
- Build passes

ENC-013: Stretch tether mechanic result data
- Added getResult() method to TetherMechanic in src/server/mechanics/tether.ts
- Result includes player1: { id, position }, player2: { id, position }, stretched: boolean
- stretched = distance >= requiredDistance at resolve time
- For point endpoints, id is null but position is returned
- Reuses existing resolveEndpointPosition() method for consistency
- Files: src/server/mechanics/tether.ts
- Build passes

ENC-014: Tether to line AOE combo script
- Created src/server/encounters/scripts/combos/tether-line-combo.ts
- tetherLineCombo exported as Script type
- Uses runner.select(random(2)) to get 2 players
- Stores selected player IDs in ctx.tetherTargets
- Spawns stretchTether mechanic between both players
- Calls runner.waitForResolve(tetherId) to await resolution
- Extracts player positions from result.data and spawns lineAoe connecting them
- Early return if < 2 players available
- Files: src/server/encounters/scripts/combos/tether-line-combo.ts
- Build passes

ENC-015: Admin runTetherLineCombo handler + button
- Added socket.on('admin:runTetherLineCombo') handler in src/server/index.ts
- Handler calls runEncounter(game, tetherLineCombo)
- Added emitRunTetherLineCombo() to __adminTest in src/client/admin.ts
- Added button #run-tether-line-btn to admin panel in public/index.html
- Button click handler emits admin:runTetherLineCombo
- Playwright verified: tether spawns between 2 players
- Files: src/server/index.ts, src/client/admin.ts, public/index.html
- Build passes

ENC-016: Multi-phase tutorial encounter
- Created src/server/encounters/scripts/encounters/tutorial-encounter.ts
- tutorialEncounter exported as Script type
- Phase 1: spawns chariot at arena center, waits 4000ms
- Phase 2: spawns spread on each player from runner.select(all()), waits 4000ms
- Phase 3: calls runner.run(tetherLineCombo)
- Phase 4: spawns chariot + spreads on all players simultaneously (no wait)
- Files: src/server/encounters/scripts/encounters/tutorial-encounter.ts
- Build passes

ENC-017: Admin runTutorialEncounter handler + button
- Added socket.on('admin:runTutorialEncounter') handler in src/server/index.ts
- Handler calls runEncounter(game, tutorialEncounter)
- Added emitRunTutorialEncounter() to __adminTest in src/client/admin.ts
- Added button #run-tutorial-btn to admin panel in public/index.html
- Button click handler emits admin:runTutorialEncounter
- Playwright verified: all 4 phases execute correctly in sequence
- Files: src/server/index.ts, src/client/admin.ts, public/index.html
- Build passes

ENC-021: Document encounter system in CLAUDE.md
- Added "Encounter System" section to CLAUDE.md
- Documented core types: Script, Context, Selector, MechanicResult
- Documented ScriptRunner API with all 6 methods
- Listed all targeting selectors (basic, advanced, combinators)
- Listed all MechanicParams types with their fields
- Added example script showing spawn, wait, select, waitForResolve usage
- Documented runEncounter() entry point
- Added table of admin buttons with IDs and __adminTest methods
- Added file structure overview
- Files: CLAUDE.md

ENC-018: Integration test - targeting selectors
- Playwright test with 2 players at different positions
- Player 1 at (400,400), Player 2 at (20,400)
- Verified random(2) returns both players via test-sequence script
- Verified all() returns all living players via tutorial-encounter Phase 2
- Verified all() returns empty when all players dead (hp=0) - Phase 4 no spreads
- Selectors work correctly through encounter system integration
- No code changes - verification only