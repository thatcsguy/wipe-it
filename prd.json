{
  "feature": "Absolute Timeline Scheduler (at() + runTimeline())",
  "summary": "Add at(absoluteTime, callback) + runTimeline() API to ScriptRunner for declarative scheduling of any action at absolute times from script start. Eliminates manual delta calculations between sequential wait() calls. Supports dynamic scheduling (at() calls during runTimeline() execution).",
  "items": [
    {
      "id": "TIMELINE-001",
      "category": "types",
      "description": "Add at() and runTimeline() methods to ScriptRunner interface in src/server/encounters/types.ts",
      "stepsToVerify": [
        "Open src/server/encounters/types.ts",
        "Verify ScriptRunner interface has: at(time: number, fn: () => void | Promise<void>): void",
        "Verify ScriptRunner interface has: runTimeline(): Promise<void>",
        "Run 'npm run build' - should compile without errors"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-002",
      "category": "infrastructure",
      "description": "Add private timeline array to ScriptRunnerImpl to store scheduled actions as {time, fn} entries",
      "stepsToVerify": [
        "Open src/server/encounters/script-runner.ts",
        "Verify private field exists: timeline: Array<{ time: number; fn: () => void | Promise<void> }> = []",
        "Run 'npm run build' - should compile without errors"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-003",
      "category": "infrastructure",
      "description": "Implement at(time, fn) method that pushes scheduled action to timeline array",
      "stepsToVerify": [
        "Open src/server/encounters/script-runner.ts",
        "Verify at() method pushes { time, fn } to this.timeline array",
        "Method should not execute fn immediately - only queues it",
        "Run 'npm run build' - should compile without errors"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-004",
      "category": "infrastructure",
      "description": "Implement runTimeline() that executes queued actions in time order with appropriate waits",
      "stepsToVerify": [
        "Open src/server/encounters/script-runner.ts",
        "Verify runTimeline() loops while this.timeline.length > 0",
        "Verify it sorts timeline by time ascending each iteration (for dynamic scheduling support)",
        "Verify it shifts first entry, calculates wait = entry.time - getElapsedTime()",
        "Verify it calls await this.wait(waitTime) if waitTime > 0",
        "Verify it awaits the entry's fn() to support async callbacks",
        "Run 'npm run build' - should compile without errors"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-005",
      "category": "dynamic-scheduling",
      "description": "runTimeline() supports dynamic at() calls during execution - new entries get inserted into remaining timeline",
      "stepsToVerify": [
        "Create test script that: calls at(0, fn1), at(2000, fn2)",
        "fn1 should call at(1000, fn3) dynamically",
        "Call runTimeline()",
        "Execution order should be: fn1 at T=0, fn3 at T=1000, fn2 at T=2000",
        "Verify by console.log timestamps or by checking side effects in order"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-006",
      "category": "scoped-isolation",
      "description": "Sub-scripts via run() get isolated timeline arrays (new runner = fresh empty timeline)",
      "stepsToVerify": [
        "Open src/server/encounters/script-runner.ts",
        "Verify run() creates new ScriptRunnerImpl (already implemented for triggerAt)",
        "New instance will have empty timeline array by default",
        "Test: parent queues items, calls run(subScript), parent's timeline unaffected by sub-script",
        "Sub-script can use its own at() + runTimeline() independently"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-007",
      "category": "script-migration",
      "description": "Migrate quad-knock.ts to use at() + runTimeline() instead of sequential await wait() calls",
      "stepsToVerify": [
        "Open src/server/encounters/scripts/combos/quad-knock.ts",
        "Replace sequential wait/action pattern with at() calls:",
        "  - at(0, () => spawn first pair with triggerAt)",
        "  - at(SECOND_PAIR_SPAWN, () => spawn second pair with triggerAt)",
        "  - at(WARNING_START, () => apply warning statuses)",
        "  - at(WARNING_START + WARNING_DURATION, () => convert to final statuses)",
        "End with: await runner.runTimeline()",
        "Optionally add final at() or wait() for cleanup timing",
        "Run 'npm run build' - should compile without errors"
      ],
      "passes": true
    },
    {
      "id": "TIMELINE-008",
      "category": "e2e-test",
      "description": "Verify migrated quad-knock.ts works correctly via Playwright - same timing behavior as before",
      "stepsToVerify": [
        "Start dev server with 'npm run dev'",
        "Use Playwright to navigate to localhost:3000?debug=1",
        "Wait for player to join",
        "Trigger quad-knock encounter via __adminTest.emitRunQuadKnock() or admin button",
        "Verify first knockback pair triggers at T~9500ms",
        "Verify second knockback pair triggers at T~11000ms",
        "Verify warning statuses applied at T~4000ms",
        "Verify final statuses (rooted/bubbled) applied at T~9000ms",
        "Timing should match pre-migration behavior (TRIGGER-009 baseline)"
      ],
      "passes": false
    }
  ]
}
