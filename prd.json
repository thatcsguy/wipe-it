{
  "feature": "Combat Log",
  "description": "Replace toast notifications with a persistent scrollable combat log showing damage and status effect changes",
  "items": [
    {
      "id": "CLOG-001",
      "category": "core",
      "description": "Create src/client/combatLog.ts with logCombat(message: string) function that appends entries to a #combat-log container. Each entry should be a div with class 'combat-entry'.",
      "stepsToVerify": [
        "File src/client/combatLog.ts exists",
        "File exports logCombat function",
        "Use Playwright: navigate to localhost:3000, join game, run __combatLogTest.log('test message') in browser console",
        "Verify #combat-log container exists and contains a .combat-entry with 'test message' text"
      ],
      "passes": true
    },
    {
      "id": "CLOG-002",
      "category": "core",
      "description": "Each combat log entry must be prefixed with timestamp in [HH:MM:SS] format using browser's local timezone. Format: '[HH:MM:SS] message'",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Run __combatLogTest.log('test') in console",
        "Verify .combat-entry text matches pattern /^\\[\\d{2}:\\d{2}:\\d{2}\\] test$/"
      ],
      "passes": true
    },
    {
      "id": "CLOG-003",
      "category": "core",
      "description": "Combat log must limit entries to 100 maximum. When a new entry is added and count exceeds 100, remove the oldest entry (first child).",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Run loop to add 105 entries: for(let i=0;i<105;i++) __combatLogTest.log('msg'+i)",
        "Verify #combat-log contains exactly 100 .combat-entry elements",
        "Verify first entry contains 'msg5' (oldest 5 were pruned)",
        "Verify last entry contains 'msg104'"
      ],
      "passes": true
    },
    {
      "id": "CLOG-004",
      "category": "core",
      "description": "Combat log must auto-scroll to bottom when new entries are added. The container should have overflow-y scroll/auto and scrollTop should equal scrollHeight - clientHeight after adding entry.",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Add 20+ entries to fill container: for(let i=0;i<25;i++) __combatLogTest.log('msg'+i)",
        "Verify container is scrolled to bottom: Math.abs(el.scrollTop - (el.scrollHeight - el.clientHeight)) < 2"
      ],
      "passes": true
    },
    {
      "id": "CLOG-005",
      "category": "ui",
      "description": "Combat log container must be positioned on the right side of the screen, below the admin panel. It should be a fixed/absolute positioned element with a max-height and scrollable overflow.",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Verify #combat-log element exists in DOM",
        "Verify computed style has overflow-y: auto or scroll",
        "Verify element is visible and positioned to the right of the canvas (check bounding rect)"
      ],
      "passes": false
    },
    {
      "id": "CLOG-006",
      "category": "ui",
      "description": "Update public/index.html: replace the action-log div with combat-log div (id='combat-log', class='combat-log').",
      "stepsToVerify": [
        "File public/index.html contains <div id=\"combat-log\"",
        "File public/index.html does NOT contain id=\"action-log\""
      ],
      "passes": true
    },
    {
      "id": "CLOG-007",
      "category": "ui",
      "description": "Update public/css/style.css: add .combat-log and .combat-entry styles. Remove all .action-log and .toast related styles (including animations).",
      "stepsToVerify": [
        "File public/css/style.css contains .combat-log selector",
        "File public/css/style.css contains .combat-entry selector",
        "File public/css/style.css does NOT contain .action-log selector",
        "File public/css/style.css does NOT contain .toast selector",
        "File public/css/style.css does NOT contain toast-slide-in or toast-fade-out"
      ],
      "passes": false
    },
    {
      "id": "CLOG-008",
      "category": "feature",
      "description": "Detect player damage by diffing GameState on each 'state' socket event. When a player's HP decreases, call logCombat with format: 'PlayerName took X damage' where X is the damage amount (oldHp - newHp).",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game with name 'TestPlayer'",
        "Click #spawn-chariot-btn to spawn a chariot mechanic",
        "Wait for mechanic to resolve and damage to occur",
        "Verify #combat-log contains entry matching 'TestPlayer took \\d+ damage'"
      ],
      "passes": false
    },
    {
      "id": "CLOG-009",
      "category": "feature",
      "description": "Detect status effect gains by diffing GameState. When a player gains a status effect not present in previous state, call logCombat with format: 'PlayerName gained EffectType'.",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game with name 'TestPlayer'",
        "Trigger a mechanic that applies a status effect (e.g., vulnerability from chariot)",
        "Verify #combat-log contains entry matching 'TestPlayer gained' followed by effect name"
      ],
      "passes": false
    },
    {
      "id": "CLOG-010",
      "category": "feature",
      "description": "Detect status effect losses by diffing GameState. When a player loses a status effect present in previous state but not in new state, call logCombat with format: 'PlayerName lost EffectType'.",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Trigger a status effect, then wait for it to expire",
        "Verify #combat-log contains entry matching 'PlayerName lost' followed by effect name"
      ],
      "passes": false
    },
    {
      "id": "CLOG-011",
      "category": "integration",
      "description": "Replace showToast call in src/client/main.ts for name changes. When player changes name, log 'Changed name to X' to combat log instead of showing toast.",
      "stepsToVerify": [
        "File src/client/main.ts imports logCombat from './combatLog'",
        "File src/client/main.ts does NOT import showToast",
        "Use Playwright: join game, click #change-name-btn, enter new name",
        "Verify #combat-log contains 'Changed name to' entry"
      ],
      "passes": false
    },
    {
      "id": "CLOG-012",
      "category": "integration",
      "description": "Remove tether resolution toast code from src/client/main.ts. The tether:resolved event handler that showed 'Tether stretched!' or 'Tether snapped!' toasts should be removed entirely.",
      "stepsToVerify": [
        "File src/client/main.ts does NOT contain 'Tether stretched'",
        "File src/client/main.ts does NOT contain 'Tether snapped'",
        "File src/client/main.ts does NOT contain 'onTetherResolution'"
      ],
      "passes": false
    },
    {
      "id": "CLOG-013",
      "category": "integration",
      "description": "Replace all showToast calls in src/client/admin.ts with logCombat calls. Messages: 'Spawned chariot', 'Spawned spreads', 'Spawned point tethers', 'Spawned player tethers', 'Healed all players'.",
      "stepsToVerify": [
        "File src/client/admin.ts imports logCombat from './combatLog'",
        "File src/client/admin.ts does NOT import showToast",
        "File src/client/admin.ts does NOT contain 'showToast'",
        "Use Playwright: join game, click #spawn-chariot-btn",
        "Verify #combat-log contains 'Spawned chariot' entry"
      ],
      "passes": false
    },
    {
      "id": "CLOG-014",
      "category": "cleanup",
      "description": "Delete src/client/toast.ts file entirely.",
      "stepsToVerify": [
        "File src/client/toast.ts does NOT exist"
      ],
      "passes": false
    },
    {
      "id": "CLOG-015",
      "category": "cleanup",
      "description": "Expose test API on window: (window as any).__combatLogTest = { log: logCombat }. Remove __toastTest global.",
      "stepsToVerify": [
        "Use Playwright: navigate to localhost:3000, join game",
        "Verify window.__combatLogTest exists and has log function",
        "Verify window.__toastTest is undefined"
      ],
      "passes": false
    },
    {
      "id": "CLOG-016",
      "category": "docs",
      "description": "Update CLAUDE.md: replace all toast documentation with combat log documentation. Update test selectors (.toast -> .combat-entry), update __toastTest -> __combatLogTest, update examples.",
      "stepsToVerify": [
        "File CLAUDE.md does NOT contain '__toastTest'",
        "File CLAUDE.md does NOT contain '.toast' selector references",
        "File CLAUDE.md contains '__combatLogTest'",
        "File CLAUDE.md contains '.combat-entry' or '#combat-log' selector references"
      ],
      "passes": false
    }
  ]
}
