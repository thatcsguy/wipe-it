{
  "feature": "Doodads",
  "description": "Visual-only elements on arena with no gameplay effect. Canvas-drawn graphics (portals, rectangles, circles) that can be positioned at fixed coordinates or anchored to players. Primary use case: portals outside arena edges indicating incoming line AOEs.",
  "items": [
    {
      "id": "DOODAD-001",
      "category": "types",
      "description": "Add DoodadState interface to shared/types.ts with fields: id, type ('portal'|'rect'|'circle'), width, height, rotation, startTime, endTime, optional opacity, layer ('background'|'foreground'), color, data. Position via x/y OR anchorPlayerId+anchorOffset. Add doodads array to GameState interface.",
      "steps_to_verify": [
        "DoodadState interface exists in src/shared/types.ts",
        "GameState interface includes 'doodads: DoodadState[]' field",
        "Type supports both fixed position (x, y) and player anchor (anchorPlayerId, anchorOffset)",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-002",
      "category": "server",
      "description": "Create DoodadManager class in src/server/doodads/manager.ts with methods: spawn(params) returns id, remove(id), tick(now) auto-removes expired doodads, getStates() returns DoodadState[].",
      "steps_to_verify": [
        "File exists: src/server/doodads/manager.ts",
        "DoodadManager class exports spawn(), remove(), tick(), getStates() methods",
        "spawn() generates unique id and returns it",
        "tick() removes doodads where endTime < now",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-003",
      "category": "server",
      "description": "Integrate DoodadManager into Game class. Instantiate manager, call tick() in game loop, include doodads in GameState broadcast.",
      "steps_to_verify": [
        "Game class creates DoodadManager instance",
        "Game tick loop calls doodadManager.tick()",
        "GameState broadcast includes doodads array from doodadManager.getStates()",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-004",
      "category": "client",
      "description": "Create client doodad rendering system in src/client/doodads/. Create index.ts with renderDoodads() dispatcher and resolvePosition() for anchored doodads. Create portal.ts with animated swirling vortex effect using gradients and rotation.",
      "steps_to_verify": [
        "File exists: src/client/doodads/index.ts with renderDoodads() function",
        "File exists: src/client/doodads/portal.ts with renderPortal() function",
        "renderDoodads() filters by layer and dispatches to type-specific renderers",
        "resolvePosition() returns player position + offset for anchored doodads",
        "Portal renderer uses serverTime to animate (rotation, pulsing)",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-005",
      "category": "client",
      "description": "Create rect.ts and circle.ts renderers in src/client/doodads/. Both should support color, opacity, rotation, and use serverTime for potential animation.",
      "steps_to_verify": [
        "File exists: src/client/doodads/rect.ts with renderRect() function",
        "File exists: src/client/doodads/circle.ts with renderCircle() function",
        "Both renderers apply rotation transform",
        "Both renderers respect color and opacity properties",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-006",
      "category": "client",
      "description": "Integrate doodad rendering into renderer.ts. Call renderDoodads() twice: once for 'background' layer after arena border (before mechanics), once for 'foreground' layer after players. Pass player positions map for anchor resolution.",
      "steps_to_verify": [
        "renderer.ts imports renderDoodads from doodads/index",
        "Background doodads render before mechanics",
        "Foreground doodads render after players",
        "Player positions passed to renderDoodads for anchor resolution",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-007",
      "category": "debug",
      "description": "Add doodad entries to debug panel in src/client/debugPanel.ts. Create .debug-doodad elements with data attributes: data-doodad-id, data-type, data-x, data-y, data-anchor-player (if anchored), data-expires.",
      "steps_to_verify": [
        "Debug panel renders .debug-doodad elements for each active doodad",
        "Each element has data-doodad-id, data-type, data-expires attributes",
        "Fixed-position doodads show data-x, data-y",
        "Anchored doodads show data-anchor-player",
        "Use Playwright: navigate to localhost:3000?debug=1, spawn a portal via admin, verify page.locator('.debug-doodad') exists with correct attributes"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-008",
      "category": "admin",
      "description": "Add 'Spawn Portal' admin button with id='spawn-portal-btn'. Add server handler for 'admin:spawnPortal' event. Add __adminTest.emitSpawnPortal(overrides?) method that spawns a test portal at a random arena edge position.",
      "steps_to_verify": [
        "Button with id='spawn-portal-btn' exists in admin panel",
        "Server handles 'admin:spawnPortal' socket event",
        "__adminTest.emitSpawnPortal() is callable from browser console",
        "Use Playwright: click #spawn-portal-btn, verify .debug-doodad[data-type='portal'] appears within 1 second",
        "Portal renders visually on canvas (take screenshot to verify)"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-009",
      "category": "scripting",
      "description": "Extend ScriptRunner interface and implementation with spawnDoodad(params) and removeDoodad(id) methods. spawnDoodad should delegate to DoodadManager.spawn() and return the id.",
      "steps_to_verify": [
        "ScriptRunner interface in src/server/encounters/types.ts includes spawnDoodad() and removeDoodad()",
        "ScriptRunnerImpl in src/server/encounters/script-runner.ts implements both methods",
        "spawnDoodad() returns doodad id",
        "removeDoodad() removes doodad before natural expiration",
        "TypeScript compilation succeeds: npm run build"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-010",
      "category": "integration",
      "description": "Update orbital-omen script to spawn portal doodads at line AOE origin points before each wave. Portals should appear outside arena edge, indicating where the line AOE will come from.",
      "steps_to_verify": [
        "orbital-omen.ts imports and uses runner.spawnDoodad()",
        "Portals spawn at positions outside arena bounds (negative x/y or > 800)",
        "Portals appear before corresponding line AOEs",
        "Use Playwright: run orbital-omen via #run-orbital-omen-btn, take screenshot, verify portal visuals appear at arena edges before line AOEs fire"
      ],
      "passes": true
    },
    {
      "id": "DOODAD-011",
      "category": "integration",
      "description": "Verify player-anchored doodads follow player movement. Create a test or use admin to spawn a circle doodad anchored to a player, then move the player and verify the doodad follows.",
      "steps_to_verify": [
        "Use Playwright: spawn circle doodad anchored to local player via browser evaluate",
        "Move player using keyboard input (WASD)",
        "Verify .debug-doodad data-x/data-y attributes update as player moves OR verify visually via screenshot that doodad follows player",
        "Doodad maintains correct offset from player position"
      ],
      "passes": false
    },
    {
      "id": "DOODAD-012",
      "category": "integration",
      "description": "Verify doodad auto-expiration works correctly. Spawn a doodad with short duration, wait for expiration, verify it disappears from both rendering and debug panel.",
      "steps_to_verify": [
        "Use Playwright: spawn portal with duration 2000ms",
        "Verify .debug-doodad element appears",
        "Wait 2500ms",
        "Verify .debug-doodad element is removed",
        "Verify doodad no longer renders on canvas"
      ],
      "passes": false
    }
  ]
}
